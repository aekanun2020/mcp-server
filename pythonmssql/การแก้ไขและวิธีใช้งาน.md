# การแก้ไขและวิธีใช้งาน MCP Server สำหรับ MSSQL

## การเปลี่ยนแปลงที่ทำ
1. เปลี่ยนจากใช้ `pyodbc` เป็น `pymssql` เพื่อเชื่อมต่อกับฐานข้อมูล MSSQL
2. แก้ไข connection string และวิธีการเชื่อมต่อให้ใช้งานได้กับ pymssql
3. ปรับปรุงการตรวจจับและรายงานข้อผิดพลาด
4. เพิ่มไฟล์ `debug_connection.py` สำหรับการทดสอบการเชื่อมต่อแบบละเอียด

## วิธีการติดตั้ง pymssql

### ติดตั้ง pymssql ด้วย conda
```bash
# สร้าง conda environment ใหม่
conda env create -f environment.yml

# หรือถ้าต้องการติดตั้งเพิ่มใน environment ที่มีอยู่แล้ว
conda activate mssql-mcp
conda install -c conda-forge pymssql
```

## ขั้นตอนการทดสอบและวิเคราะห์ปัญหาการเชื่อมต่อ

1. ก่อนอื่น ให้ทดสอบการเชื่อมต่อพื้นฐานกับเซิร์ฟเวอร์:
   ```bash
   # ทำให้สคริปต์สามารถรันได้
   chmod +x debug_connection.py
   
   # รันสคริปต์ทดสอบแบบละเอียด
   python debug_connection.py
   ```

2. สคริปต์นี้จะแสดงข้อมูลโดยละเอียดของการเชื่อมต่อและช่วยระบุปัญหา:
   - การเชื่อมต่อเครือข่ายพื้นฐาน (ทดสอบพอร์ต)
   - การเชื่อมต่อกับฐานข้อมูล
   - การทดสอบคำสั่ง SQL พื้นฐาน
   - รายละเอียดข้อผิดพลาด (ถ้ามี)

3. หากเจอปัญหาการเชื่อมต่อ อาจเกิดจากสาเหตุต่อไปนี้:
   - ไฟร์วอลล์บล็อกการเชื่อมต่อ
   - เซิร์ฟเวอร์ไม่ยอมรับการเชื่อมต่อจาก IP ของคุณ
   - ข้อมูลการเชื่อมต่อไม่ถูกต้อง (เซิร์ฟเวอร์, ฐานข้อมูล, ชื่อผู้ใช้, รหัสผ่าน)
   - SQL Server ไม่ได้ตั้งค่าให้ยอมรับการเชื่อมต่อจากระยะไกล
   - ผู้ใช้ฐานข้อมูลไม่มีสิทธิ์ที่เหมาะสม

## วิธีการใช้งาน MCP Server

1. ทดสอบการเชื่อมต่อก่อน:
   ```bash
   python test_connection.py
   ```

2. หากการเชื่อมต่อทำงานได้ ให้เริ่ม MCP Server:
   ```bash
   python mssql_server.py
   ```

3. ตั้งค่า Claude Desktop ให้ใช้ MCP Server:
   - แก้ไขไฟล์ `~/Library/Application Support/Claude/claude_desktop_config.json`
   - เพิ่มการตั้งค่า:
     ```json
     {
       "mcpServers": {
         "mssql-server": {
           "command": "/path/to/conda/envs/mssql-mcp/bin/python",
           "args": ["/Users/grizzlystudio/Desktop/pythonmssql/mssql_server.py"]
         }
       }
     }
     ```
   - แทนที่ `/path/to/conda` ด้วยพาธที่ถูกต้องของ conda ของคุณ (ใช้คำสั่ง `conda info --base` เพื่อดู)

4. รีสตาร์ท Claude Desktop และเริ่มใช้งาน

## วิธีแก้ไขปัญหาทั่วไป

### ถ้า MCP Server ไม่สามารถเชื่อมต่อกับฐานข้อมูล

1. ตรวจสอบว่าเซิร์ฟเวอร์ MSSQL กำลังทำงานอยู่และสามารถเข้าถึงได้
2. ตรวจสอบว่าข้อมูลการเชื่อมต่อ (เซิร์ฟเวอร์, ฐานข้อมูล, ชื่อผู้ใช้, รหัสผ่าน) ถูกต้อง
3. ตรวจสอบว่าพอร์ต 1433 (พอร์ตมาตรฐานของ MSSQL) เปิดอยู่และสามารถเข้าถึงได้
4. ลองเชื่อมต่อจากเครือข่ายอื่นเพื่อตรวจสอบว่าเป็นปัญหาเครือข่ายหรือไม่

### ถ้า Claude Desktop ไม่เห็น MCP Server

1. ตรวจสอบการตั้งค่าใน `claude_desktop_config.json`
2. ตรวจสอบว่าได้กำหนดเส้นทางที่ถูกต้องของ Python และสคริปต์ MCP Server
3. ตรวจสอบบันทึกของ Claude Desktop ที่:
   ```bash
   tail -f ~/Library/Logs/Claude/mcp*.log
   ```

## ข้อมูลการเชื่อมต่อปัจจุบัน

```
Server: 35.239.50.206
Database: Telco
Username: SA
Password: Passw0rd123456
```

หากต้องการเปลี่ยนแปลงข้อมูลเหล่านี้ ให้แก้ไขใน `mssql_server.py` และ `test_connection.py`
